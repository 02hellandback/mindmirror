<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mind Mirror â€” Analyze â€¢ Detect â€¢ Rewrite</title>
  <meta name="description" content="Write freely. See how you think â€” and instantly rewrite for higher readability. All local." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ§ </text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .card { box-shadow: 0 10px 25px rgba(0,0,0,.07); }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 9999px; }
    ::-webkit-scrollbar-track { background: transparent; }

    /* Fixed-height inner scrolling for large screens */
    @media (min-width: 1024px) {
      .panel-fixed { max-height: calc(100vh - 180px); overflow: auto; }
    }

    /* Chart sizing guard */
    .chart-box { height: 320px; }
    canvas { display: block; }

    /* Sticky section headers inside scrollable panels */
    .sticky-head { position: sticky; top: 0; background: white; z-index: 10; }

    .g { height: 10px; border-radius: 9999px; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 text-slate-800">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/70 border-b border-slate-200/60">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 grid place-items-center rounded-2xl bg-slate-900 text-white">MM</div>
        <div>
          <h1 class="text-xl font-bold tracking-tight">Mind Mirror</h1>
          <p class="text-xs text-slate-500">Analyze your writing, detect signals, and rewrite for clarity â€” locally.</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnExportJSON" class="px-4 py-2 rounded-2xl bg-slate-900 text-white text-sm hover:bg-slate-800">Export Analysis (JSON)</button>
        <button id="btnResetAll" class="px-4 py-2 rounded-2xl border border-slate-300 text-slate-700 text-sm hover:bg-slate-100">Reset</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Now 3 columns on xl, 2 on lg, 1 on small -->
    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
      <!-- Panel 1: Writer -->
      <section class="card rounded-3xl bg-white p-4 sm:p-6 panel-fixed">
        <div class="flex items-center justify-between mb-3 sticky-head -mx-1 px-1 py-1">
          <h2 class="text-lg font-semibold">Your Text</h2>
          <div class="text-xs text-slate-500" id="metaCounts">0 words â€¢ 0 chars</div>
        </div>
        <textarea id="inputText" class="w-full min-h-[40vh] lg:min-h-[55vh] resize-none outline-none rounded-2xl p-4 bg-slate-50/60 focus:bg-slate-50 border border-slate-200" placeholder="Describe a problem, idea, or goal.&#10;Write naturally â€” analysis and readability both run locally."></textarea>
        <div class="mt-3 flex flex-wrap items-center gap-2 text-xs text-slate-500">
          <span class="px-2 py-1 rounded-full bg-slate-100 border border-slate-200">Local â€¢ Private</span>
          <span class="px-2 py-1 rounded-full bg-slate-100 border border-slate-200">No sign-in</span>
          <span class="px-2 py-1 rounded-full bg-slate-100 border border-slate-200">Open-source ready</span>
        </div>
      </section>

      <!-- Panel 2: Analysis + AI-likeness -->
      <section class="card rounded-3xl bg-white p-4 sm:p-6 grid gap-4 content-start panel-fixed">
        <div class="flex items-center justify-between sticky-head -mx-1 px-1 py-1">
          <h2 class="text-lg font-semibold">Thinking Profile</h2>
          <span id="toneBadge" class="text-xs px-2 py-1 rounded-full border">Neutral</span>
        </div>

        <!-- Radar Chart (fixed-height box) -->
        <div class="rounded-2xl border border-slate-200 p-4 chart-box">
          <canvas id="radarChart" aria-label="Cognitive Radar" role="img" class="w-full h-full"></canvas>
          <p class="mt-2 text-xs text-slate-500">Dimensions are estimated heuristically from your text and update live.</p>
        </div>

        <!-- Metrics -->
        <div class="grid grid-cols-2 gap-3">
          <div class="rounded-2xl border border-slate-200 p-4">
            <div class="text-xs text-slate-500">Sentiment</div>
            <div class="text-2xl font-semibold" id="sentimentScore">50</div>
            <div class="text-xs text-slate-500" id="sentimentDetail">Balanced</div>
          </div>
          <div class="rounded-2xl border border-slate-200 p-4">
            <div class="text-xs text-slate-500">Readability (FRE)</div>
            <div class="text-2xl font-semibold" id="readability">â€”</div>
            <div class="text-xs text-slate-500">Higher is easier (Flesch Reading Ease).</div>
          </div>
        </div>

        <!-- AI Likeness (Experimental) -->
        <div class="rounded-2xl border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-1">
            <div>
              <div class="text-xs text-slate-500">Authorship Signals</div>
              <div class="text-sm text-slate-600">AIâ€‘Likeness (experimental)</div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-semibold" id="aiLikeness">â€”</div>
              <div class="text-xs text-slate-500" id="aiLikenessDetail">Heuristic only</div>
            </div>
          </div>
          <p class="text-xs text-slate-500">This is a simple onâ€‘device heuristic (burstiness, repetition, punctuation variety). It is <span class="font-semibold">not a reliable detector</span> and can produce false positives/negatives.</p>
        </div>

        <!-- Highlights -->
        <div class="rounded-2xl border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="text-xs text-slate-500">Key Themes</div>
              <div class="text-sm text-slate-600">Top recurring terms</div>
            </div>
            <button id="btnCopyKeywords" class="text-xs px-2 py-1 rounded-full border hover:bg-slate-50">Copy</button>
          </div>
          <div id="keywords" class="flex flex-wrap gap-2 text-sm"></div>
        </div>

        <!-- Insights -->
        <div class="rounded-2xl border border-slate-200 p-4">
          <div class="text-xs text-slate-500 mb-1">Quick Insights</div>
          <ul id="insights" class="list-disc list-inside text-sm space-y-1 text-slate-700"></ul>
        </div>

        <!-- Authorship Notes -->
        <div class="rounded-2xl border border-slate-200 p-4">
          <div class="text-xs text-slate-500 mb-1">Signals Considered (Heuristic)</div>
          <ul id="aiSignals" class="list-disc list-inside text-sm space-y-1 text-slate-700"></ul>
        </div>
      </section>

      <!-- Panel 3: Readability Rewriter -->
      <section class="card rounded-3xl bg-white p-4 sm:p-6 grid gap-4 content-start panel-fixed">
        <div class="flex items-center justify-between sticky-head -mx-1 px-1 py-1">
          <h2 class="text-lg font-semibold">Rewrite for Readability</h2>
          <div class="text-xs text-slate-500">Flesch Reading Ease</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="rounded-2xl border border-slate-200 p-4">
            <div class="flex items-center justify-between">
              <div class="text-xs text-slate-500">Target FRE</div>
              <div class="text-xs"><span id="targetFreVal" class="font-medium">70</span></div>
            </div>
            <input id="targetFre" type="range" min="40" max="95" value="70" class="w-full">
            <div class="mt-2 h-2 bg-slate-100 rounded-full overflow-hidden">
              <div id="freBarIn" class="g bg-slate-300" style="width:0%"></div>
            </div>
            <div class="mt-1 text-[11px] text-slate-500">Current FRE (input): <span id="freIn">â€”</span></div>
          </div>
          <div class="rounded-2xl border border-slate-200 p-4">
            <div class="flex items-center justify-between">
              <div class="text-xs text-slate-500">Max sentence length</div>
              <div class="text-xs"><span id="maxLenVal" class="font-medium">22</span> words</div>
            </div>
            <input id="maxLen" type="range" min="12" max="36" value="22" class="w-full">
            <div class="mt-1 text-[11px] text-slate-500">Long sentences will be split.</div>
          </div>
          <div class="rounded-2xl border border-slate-200 p-4 grid gap-2 content-start md:col-span-2">
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="rmAdverbs" type="checkbox" class="rounded" checked>
              Remove many â€˜â€‘lyâ€™ adverbs
            </label>
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="simplifyWords" type="checkbox" class="rounded" checked>
              Replace complex words
            </label>
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="deparenth" type="checkbox" class="rounded" checked>
              Remove parentheticals
            </label>
          </div>
        </div>

        <div class="flex flex-wrap gap-2">
          <button id="btnRewrite" class="px-4 py-2 rounded-2xl bg-emerald-600 text-white text-sm hover:bg-emerald-500">Rewrite from Left Panel</button>
          <button id="btnCopyOut" class="px-4 py-2 rounded-2xl border border-slate-300 text-slate-700 text-sm hover:bg-slate-100">Copy Output</button>
          <button id="btnExport" class="px-4 py-2 rounded-2xl border border-slate-300 text-slate-700 text-sm hover:bg-slate-100">Export (.txt)</button>
        </div>

        <div class="rounded-2xl border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="text-xs text-slate-500">Output FRE</div>
            <div id="freOut" class="text-xl font-semibold">â€”</div>
          </div>
          <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
            <div id="freBarOut" class="g bg-emerald-500" style="width:0%"></div>
          </div>
          <div class="mt-1 text-[11px] text-slate-500">Goal: <span id="targetFreVal2" class="font-medium">70</span></div>
        </div>

        <textarea id="outputText" class="w-full min-h-[28vh] lg:min-h-[24vh] resize-none outline-none rounded-2xl p-4 bg-slate-50 border border-slate-200" placeholder="Your simpler rewrite will appear here."></textarea>

        <div class="rounded-2xl border border-slate-200 p-4 text-xs text-slate-600">
          <div class="font-medium text-slate-700 mb-1">What changed</div>
          <ul id="changes" class="list-disc list-inside space-y-1"></ul>
        </div>
      </section>
    </div>

    <footer class="mt-8 text-center text-xs text-slate-500">
      <p>Made with â™¥ â€” all analysis and rewriting run locally in your browser.</p>
    </footer>
  </main>

  <script>
    // --------------------------
    // Shared helpers & FRE
    // --------------------------
    const by = (id) => document.getElementById(id);

    function tokenize(text){
      return text
        .toLowerCase()
        .replace(/[^a-z\s']/g,' ')
        .split(/\s+/)
        .filter(Boolean);
    }

    function countSyllables(word){
      word = word.toLowerCase();
      if(word.length <= 3) return 1;
      const vowels = 'aeiouy';
      let count = 0; let prevVowel = false;
      for(const ch of word){
        const isVowel = vowels.includes(ch);
        if(isVowel && !prevVowel) count++;
        prevVowel = isVowel;
      }
      if(word.endsWith('e')) count = Math.max(1, count - 1);
      return count || 1;
    }

    function fleschReadingEase(text){
      const sentences = Math.max(1, (text.match(/[.!?]+/g)||[]).length);
      const words = tokenize(text);
      const wordCount = Math.max(1, words.length);
      const syllables = words.reduce((a,w)=> a + countSyllables(w), 0);
      const ASL = wordCount / sentences; // avg sentence length
      const ASW = syllables / wordCount; // avg syllables per word
      const FRE = 206.835 - 1.015 * ASL - 84.6 * ASW;
      return Math.round(FRE);
    }

    // --------------------------
    // Mind Mirror analysis (as before)
    // --------------------------
    const stopwords = new Set("a,about,above,after,again,against,all,am,an,and,any,are,aren't,as,at,be,because,been,before,being,below,between,both,but,by,could,couldn't,did,didn't,do,does,doesn't,doing,don't,down,during,each,few,for,from,further,had,hadn't,has,hasn't,have,haven't,having,he,he'd,he'll,he's,her,here,here's,hers,herself,him,himself,his,how,how's,i,i'd,i'll,i'm,i've,if,in,into,is,isn't,it,it's,its,itself,let's,me,more,most,mustn't,my,myself,no,nor,not,of,off,on,once,only,or,other,ought,our,ours,ourselves,out,over,own,same,shan't,she,she'd,she'll,she's,should,shouldn't,so,some,such,than,that,that's,the,their,theirs,them,themselves,then,there,there's,these,they,they'd,they'll,they're,they've,this,those,through,to,too,under,until,up,very,was,wasn't,we,we'd,we'll,we're,we've,were,weren't,what,what's,when,when's,where,where's,which,while,who,who's,whom,why,why's,with,won't,would,wouldn't,you,you'd,you'll,you're,you've,your,yours,yourself,yourselves".split(','));

    const positive = new Set(["good","great","excellent","positive","improve","success","benefit","happy","love","win","clear","confident","optimistic","effective","progress","insight","solution","opportunity","strength"]);
    const negative = new Set(["bad","worse","worst","negative","problem","risk","issue","fail","fear","concern","uncertain","confused","doubt","weakness","blocker","bug","delay","loss"]);

    const analytical = new Set(["therefore","because","hence","thus","data","evidence","hypothesis","assumption","metric","measure","analyze","model","estimate","trade-off","constraint","root cause","system","mechanism","framework"]);
    const intuitive = new Set(["feel","intuition","gut","vibe","imagine","sense","seems","appears","instinct","vision","creative","flow","spark"]);

    const abstractTerms = new Set(["strategy","concept","idea","vision","principle","value","purpose","theory","innovation","model","plan","approach","paradigm","system","goal"]);
    const sensoryTerms = new Set(["see","hear","taste","smell","touch","color","texture","sound","bright","dark","loud","soft","warm","cold","rough","smooth","fragrant"]);

    const certainty = new Set(["definitely","clearly","certainly","must","always","never","prove","guarantee"]);
    const tentative = new Set(["maybe","perhaps","possibly","might","could","roughly","around","approximately","unclear"]);

    const pastCue = new Set(["yesterday","ago","previously","last","was","were","did"]);
    const presentCue = new Set(["now","today","currently","is","are","do","does"]);
    const futureCue = new Set(["will","soon","tomorrow","next","plan","aim","intend"]);

    function frequency(words){
      const freq = new Map();
      for(const w of words){
        if(stopwords.has(w) || w.length < 3) continue;
        freq.set(w, (freq.get(w)||0)+1);
      }
      return [...freq.entries()].sort((a,b)=> b[1]-a[1]);
    }

    function scoreRatio(a,b){
      const total = a + b;
      return total === 0 ? 0.5 : a / total;
    }

    function pickTopTerms(freqList, n = 8){
      return freqList.slice(0, n).map(([w,c])=> ({ term: w, count: c }));
    }

    function analyze(text){
      const words = tokenize(text);
      const freqList = frequency(words);

      const pos = words.filter(w=> positive.has(w)).length;
      const neg = words.filter(w=> negative.has(w)).length;
      const sentiment = Math.round(scoreRatio(pos, neg) * 100);

      const anal = words.filter(w=> analytical.has(w)).length;
      const intu = words.filter(w=> intuitive.has(w)).length;
      const analyticalRatio = scoreRatio(anal, intu);

      const abs = words.filter(w=> abstractTerms.has(w)).length;
      const conc = words.filter(w=> sensoryTerms.has(w)).length;
      const abstractRatio = scoreRatio(abs, conc);

      const cert = words.filter(w=> certainty.has(w)).length;
      const tent = words.filter(w=> tentative.has(w)).length;
      const certaintyRatio = scoreRatio(cert, tent);

      const past = words.filter(w=> pastCue.has(w)).length;
      const pres = words.filter(w=> presentCue.has(w)).length;
      const fut = words.filter(w=> futureCue.has(w)).length;

      const timeTotal = past + pres + fut || 1;
      const time = {
        past: past / timeTotal,
        present: pres / timeTotal,
        future: fut / timeTotal
      };

      const fre = fleschReadingEase(text);

      const radar = {
        Optimism: sentiment,
        Analytical: Math.round(analyticalRatio * 100),
        Abstract: Math.round(abstractRatio * 100),
        Certainty: Math.round(certaintyRatio * 100),
        Future: Math.round(time.future * 100)
      };

      const ai = aiHeuristic(text);

      return { sentiment, pos, neg, analyticalRatio, abstractRatio, certaintyRatio, time, radar, fre, freq: pickTopTerms(freqList), ai };
    }

    // --------------------------
    // AI-likeness heuristic (experimental)
    // --------------------------
    function aiHeuristic(text){
      const tokens = tokenize(text);
      const n = tokens.length || 1;
      const sentences = (text.split(/[.!?]+/).map(s=>s.trim()).filter(Boolean));
      const sLens = sentences.map(s=> tokenize(s).length).filter(x=>x>0);
      const mean = sLens.length ? sLens.reduce((a,b)=>a+b,0)/sLens.length : 0;
      const variance = sLens.length ? sLens.reduce((a,b)=> a + Math.pow(b-mean,2), 0)/sLens.length : 0;
      const burstiness = mean ? Math.sqrt(variance)/mean : 0; // higher ~ more human

      const freqList = frequency(tokens);
      const topFreq = freqList[0]?.[1] || 0;
      const repetition = topFreq / Math.max(1,n);

      const unique = new Set(tokens).size;
      const ttr = unique / Math.max(1,n);

      const punctSet = new Set((text.match(/[,:;\-â€”()\[\]"'â€¢â€¦]/g)||[]));
      const punctDiversity = punctSet.size / 12;

      const starters = sentences.map(s=> (s.split(/\s+/)[0]||'').toLowerCase()).filter(Boolean);
      const starterUnique = new Set(starters).size;
      const starterDiversity = starters.length ? starterUnique / starters.length : 1;

      const norm = (x,min,max)=> Math.max(0, Math.min(1, (x-min)/(max-min||1)));

      const fBurst = 1 - norm(burstiness, 0.2, 0.8);
      const fRept  = norm(repetition, 0.03, 0.15);
      const fPunc  = 1 - norm(punctDiversity, 0.2, 0.7);
      const fTTR   = 1 - norm(ttr, 0.35, 0.75);
      const fStart = 1 - norm(starterDiversity, 0.5, 0.9);

      const score01 = (0.28*fBurst + 0.24*fRept + 0.18*fPunc + 0.18*fTTR + 0.12*fStart);
      const score = Math.round(score01 * 100);

      const reasons = [];
      if(fBurst>0.6) reasons.push('Low variation in sentence lengths (low burstiness).');
      if(fRept>0.6) reasons.push('Unusual repetition of specific words.');
      if(fPunc>0.6) reasons.push('Limited punctuation diversity.');
      if(fTTR>0.6) reasons.push('Low lexical variety (type-token ratio).');
      if(fStart>0.6) reasons.push('Many sentences start the same way.');
      if(reasons.length===0) reasons.push('No strong AI-like signals detected by this heuristic.');

      let label = 'Uncertain';
      if(score >= 65) label = 'Possibly AI-assisted';
      else if(score <= 35) label = 'Likely human';

      return { score, label, reasons };
    }

    // --------------------------
    // Rewriter helpers
    // --------------------------
    const SIMPLE_MAP = new Map([
      ['in order to','to'],['in the event that','if'],['with regard to','about'],['with respect to','about'],
      ['due to the fact that','because'],['on account of','because'],['at this point in time','now'],['at the present time','now'],
      ['utilize','use'],['utilise','use'],['approximately','about'],['however','but'],['therefore','so'],
      ['furthermore','also'],['moreover','also'],['subsequent','later'],['prior to','before'],['commence','start'],
      ['conclude','end'],['demonstrate','show'],['assistance','help'],['obtain','get'],['purchase','buy'],
      ['individuals','people'],['numerous','many'],['sufficient','enough'],['requirement','need'],['modification','change'],
      ['methodology','method'],['approximate','about'],['significant','big'],['optimal','best'],['facilitate','help'],
      ['endeavor','try'],['indicate','show'],['nevertheless','still'],['subsequently','then'],['utilization','use'],
      ['regarding','about'],['component','part'],['objective','goal'],['parameters','limits'],['implement','add'],
      ['implementation','setup'],['leverage','use'],['attempt','try'],['mitigate','reduce'],['expedite','speed up'],
      ['capability','ability'],['capabilities','abilities'],['reference','link']
    ]);

    const FILLERS = ['basically','actually','really','very','quite','perhaps','maybe','somewhat','rather','in fact','indeed'];

    function replacePhrases(text){
      for(const [k,v] of SIMPLE_MAP.entries()){
        if(k.includes(' ')){
          const re = new RegExp('\\b'+k.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'\\b','gi');
          text = text.replace(re, v);
        }
      }
      return text;
    }

    function replaceWords(text){
      for(const [k,v] of SIMPLE_MAP.entries()){
        if(!k.includes(' ')){
          const re = new RegExp('\\b'+k.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'\\b','gi');
          text = text.replace(re, (m)=> /^[A-Z]/.test(m) ? v.charAt(0).toUpperCase()+v.slice(1) : v);
        }
      }
      return text;
    }

    function removeAdverbs(text){
      return text.replace(/\\b(\\w+?)(ly)\\b/gi, (m,root)=>{ if(/(family|reply|supply|apply|jelly|belly)/i.test(m)) return m; return root; });
    }

    function removeParentheticals(text){ return text.replace(/\s*\([^)]*\)/g,''); }

    function splitLongSentences(text, maxLen){
      const parts = text.split(/([.!?]+)\s+/);
      const out = [];
      for(let i=0;i<parts.length;i+=2){
        let sentence = (parts[i]||'').trim();
        const end = parts[i+1] || '.';
        if(!sentence) continue;
        let toks = sentence.split(/\s+/);
        while(toks.length > maxLen){
          let idx = toks.findIndex(t=> /,|and|but|which|that/i.test(t));
          if(idx===-1 || idx<6) idx = Math.min(maxLen, toks.length-1);
          out.push(toks.slice(0, idx).join(' ') + '.');
          toks = toks.slice(idx);
        }
        out.push(toks.join(' ') + (/[.!?]$/.test(end)? end : '.'));
      }
      return out.join(' ');
    }

    function cleanupSpaces(text){ return text.replace(/\s{2,}/g,' ').replace(/\s+([,.!?;:])/g,'$1').trim(); }

    function rewriteForReadability(text, opts){
      let t = text; const changes = []; const maxIter = 6; const target = opts.targetFre;
      for(let iter=0; iter<maxIter; iter++){
        const before = fleschReadingEase(t); let changed = false; const begin = t;
        if(opts.deparenth){ t = removeParentheticals(t); }
        t = replacePhrases(t);
        if(opts.rmAdverbs){ t = removeAdverbs(t); }
        if(opts.simplifyWords){ t = replaceWords(t); }
        t = splitLongSentences(t, opts.maxLen);
        t = cleanupSpaces(t);
        const after = fleschReadingEase(t);
        if(t !== begin){ changed = true; changes.push(`Pass ${iter+1}: FRE ${before} â†’ ${after}`); }
        if(after >= target || !changed){ break; }
      }
      return { text: t, changes };
    }

    // --------------------------
    // UI Wiring
    // --------------------------
    const input = by('inputText');

    // Chart
    const ctx = by('radarChart').getContext('2d');
    const radarChart = new Chart(ctx, {
      type: 'radar',
      data: { labels: ['Optimism','Analytical','Abstract','Certainty','Future'], datasets: [{ label: 'Profile', data: [50,50,50,50,50], fill: true, borderWidth: 2, pointRadius: 3 }] },
      options: { responsive: true, maintainAspectRatio: false, resizeDelay: 150, animation: { duration: 0 }, elements: { line: { borderWidth: 2 } }, scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { display: false } } }, plugins: { legend: { display: false } } }
    });

    function updateAnalysis(text){
      const a = analyze(text);
      by('metaCounts').textContent = `${tokenize(text).length} words â€¢ ${text.length} chars`;
      by('sentimentScore').textContent = a.sentiment;
      by('sentimentDetail').textContent = a.sentiment > 60 ? `Positive-leaning (${a.pos}:${a.neg})` : a.sentiment < 40 ? `Cautious-leaning (${a.pos}:${a.neg})` : `Balanced (${a.pos}:${a.neg})`;
      const badge = by('toneBadge'); badge.textContent = a.sentiment >= 70 ? 'Optimistic' : (a.sentiment <= 30 ? 'Cautious' : 'Neutral');
      by('readability').textContent = isNaN(a.fre) ? 'â€”' : a.fre;
      const r = a.radar; radarChart.data.datasets[0].data = [r.Optimism, r.Analytical, r.Abstract, r.Certainty, r.Future]; radarChart.update();
      const kw = by('keywords'); kw.innerHTML=''; a.freq.forEach(({term, count})=>{ const pill=document.createElement('span'); pill.className='px-2 py-1 rounded-full bg-slate-50 border border-slate-200'; pill.textContent=`${term} Ã—${count}`; kw.appendChild(pill); });
      const insights = by('insights'); insights.innerHTML='';
      [ a.analyticalRatio > 0.6 ? 'Reasoning language dominates over intuitive cues.' : a.analyticalRatio < 0.4 ? 'Intuitive language outweighs analytical markers.' : 'Balanced mix of analytical and intuitive cues.',
        a.abstractRatio > 0.6 ? 'Abstract scaffolding (ideas, models, strategy) is prominent.' : a.abstractRatio < 0.4 ? 'Concrete/sensory language features strongly.' : 'Blend of abstract and concrete focus.',
        a.certaintyRatio > 0.6 ? 'High certainty language; consider noting assumptions explicitly.' : a.certaintyRatio < 0.4 ? 'Hedging language present; clarity may benefit from firming decisions.' : 'Certainty and tentativeness are balanced.',
        a.time.future > 0.45 ? 'Future-oriented framing dominates.' : a.time.past > 0.45 ? 'Past/retrospective framing dominates.' : 'Present-focused or evenly distributed time framing.'
      ].forEach(b=>{ const li=document.createElement('li'); li.textContent=b; insights.appendChild(li); });

      // AI-likeness UI
      by('aiLikeness').textContent = `${a.ai.score}`; by('aiLikenessDetail').textContent = a.ai.label;
      const sig = by('aiSignals'); sig.innerHTML=''; a.ai.reasons.forEach(b=>{ const li=document.createElement('li'); li.textContent=b; sig.appendChild(li); });

      // Update rewriter meters (input side)
      const freI = a.fre; by('freIn').textContent = isNaN(freI) ? 'â€”' : freI; by('freBarIn').style.width = `${Math.max(0, Math.min(100, freI))}%`;

      return a;
    }

    input.addEventListener('input', () => updateAnalysis(input.value));

    // Rewriter events
    function syncTargets(){ by('targetFreVal').textContent = by('targetFre').value; by('targetFreVal2').textContent = by('targetFre').value; by('maxLenVal').textContent = by('maxLen').value; }
    ['targetFre','maxLen'].forEach(id=> by(id).addEventListener('input', ()=>{ syncTargets(); }));

    by('btnRewrite').addEventListener('click', ()=>{
      const opts = { targetFre: parseInt(by('targetFre').value,10), maxLen: parseInt(by('maxLen').value,10), rmAdverbs: by('rmAdverbs').checked, simplifyWords: by('simplifyWords').checked, deparenth: by('deparenth').checked };
      const { text, changes } = rewriteForReadability(input.value, opts);
      by('outputText').value = text;
      const ul = by('changes'); ul.innerHTML=''; (changes.length? changes: ['No major changes were required or detected.']).forEach(c=>{ const li=document.createElement('li'); li.textContent=c; ul.appendChild(li); });
      const freO = fleschReadingEase(text || ''); by('freOut').textContent = isNaN(freO) ? 'â€”' : freO; by('freBarOut').style.width = `${Math.max(0, Math.min(100, freO))}%`;
    });

    by('btnCopyOut').addEventListener('click', ()=>{ navigator.clipboard.writeText(by('outputText').value || '').then(()=>{ const b=by('btnCopyOut'); const t=b.textContent; b.textContent='Copied!'; setTimeout(()=> b.textContent=t, 1200); }); });
    by('btnExport').addEventListener('click', ()=>{ const blob=new Blob([by('outputText').value || ''], { type: 'text/plain' }); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='readable-output.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });

    // Global buttons
    by('btnResetAll').addEventListener('click', ()=>{ by('inputText').value=''; by('outputText').value=''; by('changes').innerHTML=''; updateAnalysis(''); by('freOut').textContent='â€”'; by('freBarOut').style.width='0%'; });
    by('btnExportJSON').addEventListener('click', () => { const analysis = updateAnalysis(input.value); const blob = new Blob([JSON.stringify(analysis, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'mind-mirror-analysis.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });

    // Demo text
    const demo = "We're exploring a product direction that balances evidence with imagination. The goal is to model trade-offs and clarify assumptions. I feel optimistic we can discover a clear path if we test quickly and learn.";
    by('inputText').value = demo; syncTargets(); updateAnalysis(demo);
  </script>
</body>
</html>

